# Feature Specification: 計算化学向け構造編集Webアプリ

**Feature Branch**: `[001-chem-model-webapp]`  
**Created**: 2026-01-05  
**Status**: Draft  
**Input**: User description + 論文草案（JCCJ Letter v8）: "計算化学の学生/研究者向けに構造の可視化・編集を効率化するツール。2構造(A/B)の同時編集、表面転写（薄いスラブ→厚いスラブ）や断片タイル合成による複合スーパーセル構築、対応原子距離のQC、格子パラメータ変換を中心機能とする。共有と重ね表示（透明度/可視制御）を必須とする。Quantum ESPRESSOの.inをターゲット。まずは座標・原子種のみ扱う。"

## ユーザーシナリオ & テスト（必須）

### User Story 1 - .in を読み込み可視化し編集する (Priority: P1)

計算化学ユーザーが QE の .in を読み込み、3D表示とテーブル編集で構造を修正できる。

**Why this priority**: 解析の出発点であり、他機能の前提になるため。

**Independent Test**: .in を読み込み、3D とテーブルが一致し、座標編集が反映されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 有効な .in ファイル、**When** アップロード/貼り付け、**Then** 原子・格子が 3D/テーブルに表示される
2. **Given** 表示済み構造、**When** テーブルで座標を編集、**Then** 3D表示が即時更新される

---

### User Story 2 - 2構造で表面転写と距離QCを行う (Priority: P2)

ユーザーが構造A/Bを並列表示し、選択した表面領域の座標を転写し、対応原子距離を確認できる。

**Why this priority**: 実験/計算条件の比較・構造改変の検証に直結するため。

**Independent Test**: A/Bを読み込み、選択原子の表面転写と対応原子距離の一覧を確認できる。

**Acceptance Scenarios**:

1. **Given** 構造A/Bが読み込み済み、**When** Aで選択した原子をBへ表面転写、**Then** Bの対応原子(同一インデックス)のCartesian座標が上書きされ、3D/テーブルに反映される
2. **Given** 構造A/Bが読み込み済み、**When** 対応原子距離を計算、**Then** インデックス対応の距離一覧が表示される（PBC時は最小像）
3. **Given** A/Bの原子数や格子が不整合、**When** 転写や距離計算を実行、**Then** 実行前に警告が表示される

---

### User Story 2b - Δ移植で小スラブの緩和変位を大スラブへ転写する (Priority: P2)

ユーザーが「小スラブ入力 + 小スラブ出力 + 大スラブ入力」を指定し、小スラブで得られた緩和変位を大スラブに適用できる。

**Why this priority**: 実験条件差の補正や表面モデル拡張における再利用が頻出のため。

**Independent Test**: 小スラブ出力の初期/最終座標から変位を計算し、初期構造座標が一致する大スラブ原子へ適用された .in が生成されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 小スラブの .in/.out と大スラブの .in が揃っている、**When** Δ移植を実行、**Then** 小スラブ出力の初期座標と一致する大スラブ原子（元素一致必須）にのみ変位が適用された .in が出力される
2. **Given** 初期座標に一致する原子が見つからない/重複する、**When** Δ移植を実行、**Then** 実行は中断され、理由が提示される
3. **Given** 小スラブ出力の ATOMIC_POSITIONS が欠落している、**When** Δ移植を実行、**Then** 実行は中断され、解析不能である旨が提示される

---

### User Story 3 - タイルパターンで複合スーパーセルを構築する (Priority: P3)

ユーザーが格子とタイルパターンを指定して複合スーパーセルを生成できる。

**Why this priority**: 研究発表や共同作業での共有・検証に重要。

**Independent Test**: 生成ルールに従ってスーパーセルが作成され、原子数・配置が期待通りになる。

**Acceptance Scenarios**:

1. **Given** 格子パラメータとタイルパターン、**When** 生成、**Then** 期待原子数と配置が得られる
2. **Given** A/Bの格子が互換、**When** 断片をタイル配置、**Then** 各タイル内のCartesian座標は保持され、タイル位置分の並進のみが適用される

---

### User Story 4 - 格子パラメータの変換 (Priority: P3)

ユーザーが格子定数とセルベクトルを相互変換し、QE入力の読み替えができる。

**Why this priority**: CELL_PARAMETERS を読み替える必要が多く、表面モデル準備の頻出作業のため。

**Independent Test**: (a,b,c,α,β,γ) とセルベクトルの相互変換ができる。

**Acceptance Scenarios**:

1. **Given** セルベクトル、**When** 変換、**Then** 格子定数と角度が表示される
2. **Given** 格子定数と角度、**When** 変換、**Then** セルベクトルが表示される

---

### User Story 5 - 共有と重ね表示を再現する (Priority: P3)

ユーザーが重ね表示の状態（可視/透明度）を共有出力で再現できる。

**Why this priority**: 共同作業や教育用途で、表示状態をそのまま共有できることが重要なため。

**Independent Test**: 共有HTMLを別環境で開き、表示状態が再現される。

**Acceptance Scenarios**:

1. **Given** 重ね表示ONで複数構造が表示中、**When** 共有HTMLを出力、**Then** 別環境で同一の重ね表示が再現される
2. **Given** 構造ごとに可視/透明度が設定済み、**When** 共有HTMLを出力、**Then** 設定が再現される

---

### Edge Cases

- .in が不完全/無効、格子情報が欠落している場合（当面は座標・原子種のみ）
- 原子数が多い場合（例: >10k）
- 不明な元素記号や部分占有、異常な座標値
- A/Bで原子数が異なる、または格子が非互換な場合の転写・距離計算
- タイル境界での重複/衝突
- 非直交セルでの変換・最小像距離計算
- オフライン環境で共有HTMLを開く場合（単一HTMLでの再現）

## 要件（必須）

### Functional Requirements

- **FR-001**: システムは Quantum ESPRESSO の .in を読み込み、原子種・座標・格子情報を抽出できる
- **FR-002**: システムは構造を 3D とテーブルで同期表示する
- **FR-003**: ユーザーは原子座標・元素種を編集できる
- **FR-004**: システムは2構造(A/B)を同時に読み込み・編集できる
- **FR-005**: システムはインデックス対応に基づき、選択原子のCartesian座標をA→Bへ転写できる（表面転写）
- **FR-005b**: システムは小スラブ入力・小スラブ出力・大スラブ入力を受け取り、出力の初期座標と一致する大スラブ原子（元素一致）に可動原子の緩和変位をΔ移植できる
- **FR-006**: システムはA/Bの対応原子距離を一覧表示できる（PBC時は最小像）
- **FR-007**: システムはタイルパターンに従って複合スーパーセルを生成できる（タイル内座標保持＋並進のみ）
- **FR-008**: システムはタイル境界の重複/衝突チェックを許容誤差付きで実行できる（任意）
- **FR-009**: システムは格子定数とセルベクトルの相互変換を提供できる（単位: alat/bohr/angstrom）
- **FR-010**: システムは QE .in を出力でき、**デフォルトは入力形式・単位を保持**する
- **FR-011**: 出力オプションは設定画面で管理し、`celldm` は**保持をデフォルト**とする（再計算・削除は将来実装）
- **FR-012**: ユーザーは重ね表示モードを切り替え、構造ごとの表示/透明度を調整できる
- **FR-013**: 共有HTML出力は重ね表示・表示/透明度設定を再現できる
- **FR-014**: 解析・編集の主要処理は FastAPI + ASE/pymatgen で実施できる
- **FR-015**: システムは Structure をバックエンドに登録し、StructureId を返すことができる（Editor v2/Supercell v2 の基盤）

### Key Entities

- **Structure**: 原子集合と格子情報を持つ構造データ
- **StructureRegistry**: StructureId で ASE Atoms を保持するバックエンドのストア
- **StructureId**: バックエンドで管理される構造ID（uuid4 hex）
- **Model**: A/B いずれかの構造コンテナ
- **Atom**: 元素記号・座標・付加フラグを保持
- **Lattice**: 格子定数/ベクトル（QE入力と相互変換）
- **Selection**: 選択した原子集合と操作履歴
- **SurfaceTransfer**: インデックス対応に基づく座標転写ルール
- **DeltaTransplant**: 小スラブ出力の最終座標から変位を算出し、大スラブ可動原子へ適用するルール
- **DistanceReport**: A/B対応原子の距離一覧
- **TilingPattern**: 2D配列/GUIで定義されるタイル配置
- **SupercellGrid**: StructureId を 2D 配列で並べたタイル配置（軸対応を含む）
- **SupercellRecipe**: パターンと拡張倍率
- **ExportSettings**: 出力単位・座標形式・celldm方針
- **ViewState**: 重ね表示モード、構造ごとの表示/透明度

## 成功条件（必須）

### Measurable Outcomes

- **SC-001**: 代表的な .in（~1k原子）を読み込み、3D表示まで 3 秒以内
- **SC-002**: テーブル編集が 300ms 以内で 3D に反映される
- **SC-003**: 表面転写がインデックス対応で正しく反映される（距離差分が期待通り）
- **SC-003b**: Δ移植で可動原子の変位が小スラブ出力の初期→最終の差分に一致する
- **SC-004**: タイルパターン生成で期待原子数と配置が得られる
- **SC-005**: 格子変換がQEのCELL_PARAMETERSと整合する
- **SC-006**: 共有HTMLで重ね表示と可視/透明度が再現できる

## 未確定事項（要確認）

- Δ移植の出力は「移植済み .in テキストのみ」でよいか
- 可動フラグが欠落している場合の扱い（全可動扱い or エラー）
- wrap は Lx/Ly のみでよいか（非直交セルの扱い）
- UI配置（既存Editor内に追加 or 専用ページ）
  - 新UIプロトタイプのURL確定（暫定: `/editor-v2`）

## 決定事項

- Δ移植の出力は「移植済み .in テキスト」のみ
- 可動フラグが欠落している場合はエラー表示で中断
- 非直交セルは未対応（wrap は Lx/Ly のみ）
- UIは専用ページに実装（将来統合の可能性あり）
- 新UIのモック/機能接続は別ルートで段階的に進める（暫定: `/editor-v2`）
- `/structures` は Structure 直接登録に切り替え、QE などのインポートは `/structures/import` に分離する
- Supercell v2 は StructureId の 2D グリッドを受け取り、格子は `baseStructureId` の lattice を基準にする（デフォルト軸: row->b, col->a）
