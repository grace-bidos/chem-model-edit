name: CI

on:
  pull_request:
  merge_group:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web == 'true' || steps.filter.outputs.ci == 'true' }}
      api: ${{ steps.filter.outputs.api == 'true' || steps.filter.outputs.ci == 'true' }}
      contract: ${{ steps.filter.outputs.contract == 'true' || steps.filter.outputs.ci == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Detect code changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ci:
              - '.github/workflows/ci.yml'
              - '.github/workflows/full-ci.yml'
              - '.github/workflows/deploy-workers.yml'
            web:
              - 'apps/web/**'
              - 'packages/shared/**'
              - 'packages/api-client/**'
              - 'knip.json'
              - 'nx.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
            api:
              - 'apps/api/**'
              - 'scripts/api/**'
              - 'apps/api/pyproject.toml'
              - 'apps/api/uv.lock'
            contract:
              - 'apps/api/app/**'
              - 'apps/api/services/**'
              - 'apps/api/main.py'
              - 'apps/api/scripts/export_openapi.py'
              - 'packages/api-client/**'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'apps/api/pyproject.toml'
              - 'apps/api/uv.lock'

  route:
    runs-on: ubuntu-latest
    outputs:
      trusted: ${{ steps.pick.outputs.trusted }}
      runner: ${{ steps.pick.outputs.runner }}
      use_gha_cache: ${{ steps.pick.outputs.use_gha_cache }}
    steps:
      - name: Select runner target
        id: pick
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_IS_FORK: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork || false }}
          AUTHOR_ASSOCIATION: ${{ github.event.pull_request.author_association || '' }}
          ACTOR: ${{ github.actor }}
          SELF_HOSTED_ENABLED: ${{ vars.CI_SELF_HOSTED_TRUSTED_ROUTING || 'false' }}
        run: |
          set -euo pipefail
          trusted="false"
          if [[ "${SELF_HOSTED_ENABLED}" == "true" ]] \
            && [[ "${EVENT_NAME}" == "pull_request" ]] \
            && [[ "${PR_IS_FORK}" == "false" ]] \
            && [[ "${ACTOR}" != "dependabot[bot]" ]] \
            && [[ ! "${ACTOR}" =~ \[bot\]$ ]] \
            && [[ "${AUTHOR_ASSOCIATION}" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]]; then
            trusted="true"
          fi

          if [[ "${trusted}" == "true" ]]; then
            echo 'runner=["self-hosted","linux","x64","chem-trusted-pr"]' >> "${GITHUB_OUTPUT}"
            echo 'use_gha_cache=false' >> "${GITHUB_OUTPUT}"
          else
            echo 'runner="ubuntu-latest"' >> "${GITHUB_OUTPUT}"
            echo 'use_gha_cache=true' >> "${GITHUB_OUTPUT}"
          fi
          echo "trusted=${trusted}" >> "${GITHUB_OUTPUT}"

  web:
    needs:
      - changes
      - route
    if: ${{ github.event_name == 'push' || github.event_name == 'merge_group' || needs.changes.outputs.web == 'true' }}
    runs-on: ${{ fromJSON(needs.route.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0
          run_install: false
      - name: Export pnpm to PATH
        run: echo "$PNPM_HOME" >> "$GITHUB_PATH"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Configure pnpm store path
        run: pnpm config set store-dir "$HOME/.pnpm-store"
      - name: Restore pnpm store cache
        if: ${{ needs.route.outputs.use_gha_cache == 'true' }}
        id: pnpm-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-node22-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node22-pnpm-
            ${{ runner.os }}-pnpm-
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
      - name: Save pnpm store cache (main only)
        if: ${{ needs.route.outputs.use_gha_cache == 'true' && github.ref == 'refs/heads/main' && steps.pnpm-cache-restore.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: ~/.pnpm-store
          key: ${{ steps.pnpm-cache-restore.outputs.cache-primary-key }}
      - name: Lint
        run: pnpm exec nx run web:lint
      - name: Typecheck
        run: pnpm exec nx run web:typecheck
      - name: Unit tests
        run: pnpm exec nx run web:test

  api:
    needs:
      - changes
      - route
    if: ${{ github.event_name == 'push' || github.event_name == 'merge_group' || needs.changes.outputs.api == 'true' }}
    runs-on: ${{ fromJSON(needs.route.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          restore-cache: true
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-suffix: api-py3.13
          cache-dependency-glob: |
            apps/api/uv.lock
            apps/api/pyproject.toml
      - name: Install dependencies
        run: uv sync --dev
        working-directory: apps/api
      - name: Ruff
        run: uv run ruff check .
        working-directory: apps/api
      - name: Mypy
        run: uv run mypy --config-file pyproject.toml app services main.py
        working-directory: apps/api
      - name: Pytest
        run: uv run pytest --cov=app --cov=services --cov=main --cov-report=term-missing --cov-report=xml:coverage.xml
        working-directory: apps/api
      - name: Fetch PR base ref for diff coverage
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          set -euo pipefail
          git fetch --no-tags --prune origin "${{ github.base_ref }}"
      - name: Pyright touched-files gate
        if: ${{ github.event_name == 'pull_request' }}
        env:
          BASE_REF: origin/${{ github.base_ref }}
        run: uv run --project apps/api python scripts/api/pyright_touched_gate.py --base-ref "$BASE_REF"
      - name: Changed-lines coverage gate
        if: ${{ github.event_name == 'pull_request' }}
        env:
          BASE_REF: origin/${{ github.base_ref }}
          COVERAGE_DIFF_THRESHOLD: '90'
        run: |
          uv run --project apps/api python - "$BASE_REF" "$COVERAGE_DIFF_THRESHOLD" <<'PY'
          import re
          import subprocess
          import sys
          import xml.etree.ElementTree as ET
          from pathlib import Path

          base_ref = sys.argv[1]
          threshold = float(sys.argv[2])

          coverage_path = Path("apps/api/coverage.xml")
          if not coverage_path.exists():
              print(f"coverage report not found: {coverage_path}", file=sys.stderr)
              sys.exit(2)

          tree = ET.parse(coverage_path)
          root = tree.getroot()

          measurable: dict[str, set[int]] = {}
          covered: dict[str, set[int]] = {}

          for klass in root.findall(".//class"):
              filename = klass.attrib.get("filename")
              if not filename:
                  continue
              key = Path(filename).as_posix()
              measurable.setdefault(key, set())
              covered.setdefault(key, set())
              for line in klass.findall("./lines/line"):
                  number_text = line.attrib.get("number")
                  hits_text = line.attrib.get("hits", "0")
                  if number_text is None:
                      continue
                  line_no = int(number_text)
                  hits = int(hits_text)
                  measurable[key].add(line_no)
                  if hits > 0:
                      covered[key].add(line_no)

          diff = subprocess.check_output(
              [
                  "git",
                  "diff",
                  "--unified=0",
                  "--no-color",
                  f"{base_ref}...HEAD",
                  "--",
                  "apps/api",
              ],
              text=True,
          )

          changed: dict[str, set[int]] = {}
          current_file: str | None = None
          new_line: int | None = None

          for raw in diff.splitlines():
              if raw.startswith("+++ b/"):
                  path = raw[6:]
                  current_file = path if path.endswith(".py") else None
                  if current_file is not None and current_file.startswith("apps/api/"):
                      current_file = current_file[len("apps/api/") :]
                  continue
              if raw.startswith("@@"):
                  match = re.search(r"\+(\d+)(?:,(\d+))?", raw)
                  if not match:
                      new_line = None
                      continue
                  new_line = int(match.group(1))
                  continue
              if current_file is None or new_line is None:
                  continue
              if raw.startswith("+") and not raw.startswith("+++"):
                  changed.setdefault(current_file, set()).add(new_line)
                  new_line += 1
              elif raw.startswith("-") and not raw.startswith("---"):
                  continue
              elif raw.startswith(" "):
                  new_line += 1

          measured_total = 0
          covered_total = 0
          missing: list[str] = []

          for filename, changed_lines in sorted(changed.items()):
              measurable_lines = measurable.get(filename, set())
              covered_lines = covered.get(filename, set())
              for line_no in sorted(changed_lines):
                  if line_no not in measurable_lines:
                      continue
                  measured_total += 1
                  if line_no in covered_lines:
                      covered_total += 1
                  else:
                      missing.append(f"{filename}:{line_no}")

          if measured_total == 0:
              print(f"Changed-lines coverage: no measurable Python lines changed vs {base_ref}; gate passes.")
              sys.exit(0)

          percent = (covered_total / measured_total) * 100.0
          print(
              f"Changed-lines coverage: {covered_total}/{measured_total} = {percent:.2f}% "
              f"(threshold {threshold:.2f}%, base {base_ref})"
          )
          if missing:
              print("Uncovered changed lines:")
              for item in missing:
                  print(f"  - {item}")

          if percent + 1e-9 < threshold:
              sys.exit(1)
          PY

  contract:
    needs:
      - changes
      - route
    if: ${{ github.event_name == 'push' || github.event_name == 'merge_group' || needs.changes.outputs.contract == 'true' }}
    runs-on: ${{ fromJSON(needs.route.outputs.runner) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          restore-cache: true
          save-cache: ${{ github.ref == 'refs/heads/main' }}
          cache-suffix: contract-py3.13
          cache-dependency-glob: |
            apps/api/uv.lock
            apps/api/pyproject.toml
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.27.0
          run_install: false
      - name: Export pnpm to PATH
        run: echo "$PNPM_HOME" >> "$GITHUB_PATH"
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Configure pnpm store path
        run: pnpm config set store-dir "$HOME/.pnpm-store"
      - name: Restore pnpm store cache
        if: ${{ needs.route.outputs.use_gha_cache == 'true' }}
        id: pnpm-cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-node22-pnpm-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node22-pnpm-
            ${{ runner.os }}-pnpm-
      - name: Install Python dependencies
        run: uv sync --dev
        working-directory: apps/api
      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile --prefer-offline
      - name: Save pnpm store cache (main only)
        if: ${{ needs.route.outputs.use_gha_cache == 'true' && github.ref == 'refs/heads/main' && steps.pnpm-cache-restore.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: ~/.pnpm-store
          key: ${{ steps.pnpm-cache-restore.outputs.cache-primary-key }}
      - name: Check OpenAPI artifact drift
        run: PYTHONPATH=apps/api uv run --project apps/api python apps/api/scripts/export_openapi.py --check
      - name: Regenerate API client
        run: pnpm -C packages/api-client run generate
      - name: Check generated API client schema is committed
        run: git diff --exit-code -- packages/api-client/src/generated/schema.ts
