name: PR Policy

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review]
  merge_group:

permissions:
  contents: read
  pull-requests: read

jobs:
  pr-metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body metadata
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const failures = [];

            const linear = body.match(/Linear Issue:\s*([A-Z]+-\d+)/i);
            const type = body.match(/Type:\s*(Ask|Show|Ship)/i);
            const size = body.match(/Size:\s*(XS|S|M|L)/i);
            const queue = body.match(/Queue Policy:\s*(Required|Optional)/i);
            const stack = body.match(/Stack:\s*(Standalone|Base|Depends on #\d+)/i);

            if (!linear) failures.push("Missing `Linear Issue: <KEY-NUMBER>`");
            if (!type) failures.push("Missing `Type: Ask | Show | Ship`");
            if (!size) failures.push("Missing `Size: XS | S | M | L`");
            if (!queue) failures.push("Missing `Queue Policy: Required | Optional`");
            if (!stack) failures.push("Missing `Stack: Standalone | Base | Depends on #<PR>`");

            const requiredChecked = /- \[x\] Required/i.test(body);
            const optionalChecked = /- \[x\] Optional/i.test(body);
            if (!requiredChecked && !optionalChecked) {
              failures.push("CodeRabbit Policy must select one option (`Required` or `Optional`).");
            }
            if (requiredChecked && optionalChecked) {
              failures.push("CodeRabbit Policy must select only one option.");
            }

            if (size && queue) {
              const sizeValue = size[1].toUpperCase();
              const queueValue = queue[1].toLowerCase();
              if (sizeValue === "L" && queueValue === "required") {
                failures.push("`Size: L` cannot use `Queue Policy: Required`. Split into smaller PRs first.");
              }
            }

            if (failures.length > 0) {
              core.setFailed(`PR policy failed:\n- ${failures.join("\n- ")}`);
            } else {
              core.info("PR policy passed.");
            }

      - name: Merge queue compatibility
        if: ${{ github.event_name == 'merge_group' }}
        run: echo "merge_group event detected; PR metadata is validated on pull_request events."
